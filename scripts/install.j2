#!/bin/bash

#=================================================
# SOURCE HELPERS
#=================================================

{% for file in files_to_source -%}
source {{ file }}
{% endfor -%}
source /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

ynh_clean_setup () {
	ynh_clean_check_starting
}
# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# RETRIEVE ARGUMENTS FROM THE MANIFEST
#=================================================

app=$YNH_APP_INSTANCE_NAME

{% for arg in manifest.arguments.install -%}
{{arg.name}}=$YNH_APP_ARG_{{arg.name|upper}}
{% endfor %}

{% for alias_ in global_.legacy_aliases -%}
# Stupid alias for backward compatibility with some helpers
{{alias_}}
{% endfor %}

#=================================================
# BOOK RESOURCES
#=================================================
ynh_script_progression --message="Booking resources for app..."

{% for resource in resources %}
# --------------------
# Book {{ resource.name }}
# --------------------
{{ resource.code.install }}
{% endfor %}

# TODO: ADDITIONAL TESTS

#=================================================
# STORE SETTINGS FROM MANIFEST
#=================================================
ynh_script_progression --message="Storing installation settings..."

{% for arg in manifest.arguments.install %}
ynh_app_setting_set --app=$app --key={{arg.name}} --value=${{arg.name}}
{%- endfor %}

{% for resource in resources -%}
{%- for setting in resource.settings %}
ynh_app_setting_set --app=$app --key={{setting}} --value=${{setting}}
{%- endfor -%}
{%- endfor %}

{% for step in steps %}
#=================================================
# {{ step.type|upper }}
#=================================================
ynh_script_progression --message="{{ step.description }}..."

{{ step.code.install }}

{% endfor %}
